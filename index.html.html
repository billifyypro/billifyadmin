<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Billify</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --panel: #09090b; --border: #27272a; --primary: #6366f1; --text: #f4f4f5; --success: #10b981; --danger: #ef4444; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .nav { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: #a1a1aa; font-weight: 500; display: flex; gap: 10px; align-items: center; }
        .nav:hover, .nav.active { background: var(--primary); color: white; }

        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.3s ease; } .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        .card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; color: white; margin-left: 5px; font-weight: 600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-blue { background: var(--primary); } .btn-yellow { background: #eab308; color: black; }
        input, select, textarea { background: #000; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; margin-bottom: 10px; outline: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-box { background: var(--panel); width: 600px; padding: 25px; border-radius: 16px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .modal-sec { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div class="sidebar">
        <h2 style="color:var(--primary); margin-top:0;">Billify Admin</h2>
        <div class="nav active" onclick="tab('orders')">Orders</div>
        <div class="nav" onclick="tab('renewals')">Renewals</div>
        <div class="nav" onclick="tab('users')">Users</div>
        <div class="nav" onclick="tab('plans')">Plans</div>
        <div class="nav" onclick="tab('designs')">Designs</div>
        <div class="nav" onclick="tab('settings')">Settings</div>
    </div>

    <div class="main">
        <div id="pg-orders" class="page active"><h2>Orders</h2><div id="order-list">Loading...</div></div>
        
        <div id="pg-renewals" class="page"><h2>Renewals</h2><div id="renewal-list">Loading...</div></div>

        <div id="pg-users" class="page"><h2>User Manager</h2><input id="user-search" placeholder="Search..." onkeyup="searchUsers()"><div id="user-list">Loading...</div></div>

        <div id="pg-plans" class="page">
            <h2>Plans</h2>
            <div class="card" style="display:block;">
                <h4 id="plan-mode" style="margin-top:0">Add Plan</h4>
                <input type="hidden" id="pl-id">
                <input id="pl-n" placeholder="Name">
                <div style="display:flex; gap:10px;"><input id="pl-p" placeholder="Price"><input id="pl-d" placeholder="Days"></div>
                <textarea id="pl-desc" placeholder="Description" rows="2"></textarea>
                <button id="btn-save" class="btn btn-green" onclick="savePlan()">Add</button>
                <button id="btn-cancel" class="btn btn-red" style="display:none;" onclick="resetPlan()">Cancel</button>
            </div>
            <div id="plan-list"></div>
        </div>

        <div id="pg-designs" class="page"><h2>Designs</h2><div class="card" style="display:block;"><input id="ds-n" placeholder="Name"><input id="ds-u" placeholder="URL"><button class="btn btn-blue" onclick="addDesign()">Add</button></div><div id="design-list"></div></div>

        <div id="pg-settings" class="page"><h2>Settings</h2><input id="set-qr" placeholder="QR URL"><input id="set-auto" placeholder="Free Trial URL"><button class="btn btn-green" onclick="saveSet()">Save</button></div>
    </div>

    <div id="user-modal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h2>Manage</h2><button class="btn btn-red" onclick="closeModal()">X</button></div>
            <div id="m-profile" style="margin-bottom:15px; color:#9ca3af;"></div>
            <div class="modal-sec" style="border-left:3px solid var(--success)"><h4>Gift</h4><select id="gift-plan"></select><div style="display:flex; gap:10px;"><input id="gift-site" placeholder="Site"><input id="gift-url" placeholder="URL"></div><button class="btn btn-green" style="width:100%" onclick="giftSub()">Gift</button></div>
            <div class="modal-sec"><h4>Websites</h4><div id="m-webs"></div><div style="display:flex; gap:5px; margin-top:5px;"><input id="new-web-n" placeholder="Name"><input id="new-web-u" placeholder="URL"><button class="btn btn-blue" onclick="manualWeb()">Add</button></div></div>
            <div class="modal-sec"><h4>Subs</h4><div id="m-subs"></div></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCX5qpT_ytgJjRk21-VWZ-Ndhbq0hhjXYo", authDomain: "fir-integration-61a1f.firebaseapp.com", databaseURL: "https://fir-integration-61a1f-default-rtdb.firebaseio.com", projectId: "fir-integration-61a1f", storageBucket: "fir-integration-61a1f.firebasestorage.app", messagingSenderId: "178334018866", appId: "1:178334018866:web:ef78bc307549639d0ebb2b" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let allUsers = [], currentUid = null;

        function tab(id){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav').forEach(n=>n.classList.remove('active')); document.getElementById('pg-'+id).classList.add('active'); }

        // ORDERS
        db.ref('subscriptions').orderByChild('status').equalTo('pending').on('value',s=>{const e=document.getElementById('order-list');e.innerHTML='';if(s.exists())s.forEach(c=>{const o=c.val();e.innerHTML+=`<div class="card"><b>${o.planName}</b> (${o.price}) - ${o.name}<br>Pay: ${o.payerName} | Txn: ${o.txnId}<br><button class="btn btn-green" onclick="approve('${c.key}',${o.durationDays},'${o.uid}','${o.websiteName}')">Approve</button></div>`})});
        function approve(k,d,uid,name){const u=prompt("URL:");if(u){db.ref('subscriptions/'+k).update({status:'active',websiteUrl:u,expiryDate:Date.now()+(d*86400000)});db.ref('websites').push({owner:uid,name:name,url:u,status:'live'});}}

        // RENEWALS (WITH PLAN NAME)
        db.ref('renewals').on('value',s=>{const e=document.getElementById('renewal-list');e.innerHTML='';if(s.exists())s.forEach(c=>{const r=c.val();e.innerHTML+=`<div class="card" style="display:block; border-left:3px solid #eab308"><div><b style="color:#eab308">RENEW: ${r.websiteName}</b> <span style="background:#333; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${r.planName}</span></div><div style="font-size:0.9rem; color:#999; margin:5px 0;">User: ${r.name} (${r.mobile})<br>PayName: ${r.payerName}<br>Txn: ${r.txnId} | Price: ${r.price}</div><div style="margin-top:10px;"><button class="btn btn-green" onclick="renew('${c.key}','${r.originalSubId}',${r.durationDays})">Extend</button><button class="btn btn-red" onclick="db.ref('renewals/${c.key}').remove()">Reject</button></div></div>`})});
        async function renew(k,sid,d){if(confirm("Extend?")){const sub=await db.ref('subscriptions/'+sid).get();if(sub.exists()){let base=Math.max(sub.val().expiryDate,Date.now());await db.ref('subscriptions/'+sid).update({expiryDate:base+(d*86400000)});await db.ref('renewals/'+k).remove();alert("Done");}}}

        // PLANS (ADD + EDIT)
        db.ref('plans').on('value',s=>{const e=document.getElementById('plan-list');e.innerHTML='';if(s.exists())s.forEach(c=>{const p=c.val();e.innerHTML+=`<div class="card"><div><b>${p.name}</b><br>${p.price} | ${p.days} Days</div><div><button class="btn btn-yellow" onclick="editPlan('${c.key}','${p.name}','${p.price}','${p.days}','${p.desc||''}')">Edit</button><button class="btn btn-red" onclick="db.ref('plans/${c.key}').remove()">Del</button></div></div>`})});
        function savePlan(){
            const id=document.getElementById('pl-id').value;
            const d={name:document.getElementById('pl-n').value,price:document.getElementById('pl-p').value,days:document.getElementById('pl-d').value,desc:document.getElementById('pl-desc').value};
            if(id){db.ref('plans/'+id).update(d);}else{db.ref('plans').push(d);} resetPlan();
        }
        function editPlan(k,n,p,d,desc){
            document.getElementById('pl-id').value=k; document.getElementById('pl-n').value=n; document.getElementById('pl-p').value=p; document.getElementById('pl-d').value=d; document.getElementById('pl-desc').value=desc;
            document.getElementById('plan-mode').innerText="Edit Plan"; document.getElementById('btn-save').innerText="Update"; document.getElementById('btn-cancel').style.display='inline-block';
        }
        function resetPlan(){
            document.getElementById('pl-id').value=''; document.getElementById('pl-n').value=''; document.getElementById('pl-p').value=''; document.getElementById('pl-d').value=''; document.getElementById('pl-desc').value='';
            document.getElementById('plan-mode').innerText="Add Plan"; document.getElementById('btn-save').innerText="Add"; document.getElementById('btn-cancel').style.display='none';
        }

        // USERS
        db.ref('users').on('value',s=>{allUsers=[];s.forEach(c=>{allUsers.push({key:c.key,...c.val()})}); renderUsers(allUsers);});
        function renderUsers(l){const el=document.getElementById('user-list');el.innerHTML='';l.forEach(u=>{el.innerHTML+=`<div class="card"><b>${u.profile?.name||'User'}</b><br>${u.profile?.mobile||'-'}<button class="btn btn-blue" onclick="openUser('${u.key}')">Manage</button></div>`});}
        function searchUsers(){const q=document.getElementById('user-search').value.toLowerCase(); renderUsers(allUsers.filter(u=>(u.profile?.name||'').toLowerCase().includes(q)));}

        async function openUser(uid){
            currentUid=uid; document.getElementById('user-modal').style.display='flex';
            const u=allUsers.find(x=>x.key===uid); document.getElementById('m-profile').innerHTML=`Name: ${u.profile?.name}<br>Mobile: ${u.profile?.mobile}`;
            const p=await db.ref('plans').get(); const sel=document.getElementById('gift-plan'); sel.innerHTML=''; if(p.exists())p.forEach(c=>sel.innerHTML+=`<option value="${c.val().name}|${c.val().days}">${c.val().name}</option>`);
            loadDetails(uid);
        }
        function loadDetails(uid){
            db.ref('websites').orderByChild('owner').equalTo(uid).on('value',s=>{const e=document.getElementById('m-webs');e.innerHTML='';if(s.exists())s.forEach(c=>e.innerHTML+=`<div style="display:flex;justify-content:space-between;background:#000;padding:5px;margin-bottom:5px;">${c.val().name} <button class="btn btn-red" onclick="db.ref('websites/${c.key}').remove()">Del</button></div>`)});
            db.ref('subscriptions').orderByChild('uid').equalTo(uid).on('value',s=>{const e=document.getElementById('m-subs');e.innerHTML='';if(s.exists())s.forEach(c=>{if(c.val().status==='active')e.innerHTML+=`<div style="background:#000;padding:5px;margin-bottom:5px;">${c.val().planName} | Exp: ${new Date(c.val().expiryDate).toLocaleDateString()} <button class="btn btn-blue" onclick="editDate('${c.key}')">Edit</button></div>`})});
        }
        function giftSub(){const[n,d]=document.getElementById('gift-plan').value.split('|'); const s=document.getElementById('gift-site').value; const u=document.getElementById('gift-url').value; if(s){db.ref('subscriptions').push({uid:currentUid,planName:n,websiteName:s,websiteUrl:u,status:'active',expiryDate:Date.now()+(d*86400000)}); db.ref('websites').push({owner:currentUid,name:s,url:u,status:'live'}); alert("Gifted");}}
        function manualWeb(){const n=document.getElementById('new-web-n').value; const u=document.getElementById('new-web-u').value; if(n){db.ref('websites').push({owner:currentUid,name:n,url:u,status:'live'});}}
        function editDate(k){const d=prompt("YYYY-MM-DD"); if(d) db.ref('subscriptions/'+k).update({expiryDate:new Date(d).getTime()});}
        function closeModal(){document.getElementById('user-modal').style.display='none';}

        // OTHER
        function addDesign(){db.ref('portfolios').push({name:document.getElementById('ds-n').value,url:document.getElementById('ds-u').value})}
        db.ref('portfolios').on('value',s=>{const e=document.getElementById('design-list');e.innerHTML='';if(s.exists())s.forEach(c=>e.innerHTML+=`<div class="card">${c.val().name} <button onclick="db.ref('portfolios/${c.key}').remove()">X</button></div>`)});
        function saveSet(){db.ref('settings/qrCodeUrl').set(document.getElementById('set-qr').value);db.ref('settings/autoFreeUrl').set(document.getElementById('set-auto').value);alert("Saved");}
        db.ref('settings').on('value',s=>{if(s.val()){document.getElementById('set-qr').value=s.val().qrCodeUrl||'';document.getElementById('set-auto').value=s.val().autoFreeUrl||'';}});
    </script>
</body>
</html>